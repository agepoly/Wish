<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<style>
body {
    background-color: linen;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
}
#slots {
    display: inline-block;
}
h1 {
    color: maroon;
    margin-left: 20px;
} 
</style>

<script>
$(document).ready(function() {
	$("input[name='nslots']").bind('input propertychange', create_slots);
	$("#send").click(send);
	$("input").bind('input propertychange', check_validity);
	$("textarea").bind('input propertychange', check_validity);
	$("input[name='deadline']").prop('min', new Date().toJSON().split('T')[0]);
	$("#output").hide();
	create_slots();
	check_validity();
});

function send() {
	var slots = get_slot_val();
	var deadline = new Date($("input[name='deadline']").val()).getTime();
	
	var payload = '{'
		+'"name"     : "'+$("input[name='name']").val()+'", '
		+'"deadline" : '+deadline+', '
		+'"mails"    : ["'+$("#mails").val().split(/[\s,]+/).join('","')+'"], '
		+'"slots"    : ["'+slots.slot.join('","')+'"], '
		+'"vmin"     : ['+ slots.vmin.join(',')  +'], '
		+'"vmax"     : ['+ slots.vmax.join(',')  +']'
		+'}';
	
	console.log(payload);
	
	$.post("/create", payload, function(data,status) {
		if (status == "success") {
			var x = eval('(' + data + ')');
			var url = window.location.hostname + ":" + window.location.port + "/get/";
			var content = "";
			for (i=0; i < x.people.length; ++i) {
				content += x.people[i].mail+", "+url+x.people[i].key+"\n";
			}
			$("#output").html(content);
			$("#output").show();
		}
	});
}
	
function create_slots() {
	var n = $("input[name='nslots']").val();
	var oldvalues = get_slot_val();
	
	var content = "<table><tr><th>Slot Name</th><th>Min Bound</th><th>Max Bound</th></tr>";
	for (i=0; i < n; ++i) {
		var values = {
			name: "no "+(i+1),
			vmin: "0",
			vmax: "10"
		};
		if (i < oldvalues.slot.length) {
			values.name = oldvalues.slot[i];
			values.vmin = oldvalues.vmin[i];
			values.vmax = oldvalues.vmax[i];
		}
		content += '<tr><th><input type="text" class="slot" name="slot'+i+'" value="'+values.name+'"></th>'
			+ '<th><input type="number" class="vmin" name="vmin'+i+'" min="0" max="100" step="1" value="'+values.vmin+'"></th>'
			+ '<th><input type="number" class="vmax" name="vmax'+i+'" min="0" max="100" step="1" value="'+values.vmax+'"></th></tr>'
	}
	content += "</table>";
	$("#slots").html(content);
	$("input").bind('input propertychange', check_validity);
}

function get_slot_val() {
	var slot = [];
	var vmin = [];
	var vmax = [];
	for (var i = 0; $("input[name='slot"+i+"']").length; ++i) {
		slot.push($("input[name='slot"+i+"']").val());
		vmin.push($("input[name='vmin"+i+"']").val());
		vmax.push($("input[name='vmax"+i+"']").val());
	}
	
	return { slot: slot, vmin: vmin, vmax: vmax };
}

function check_validity() {
	if ($("input[name='name']").val() == "") {
		$("input[name='name']").css({'border-color' : '#FF0000'});
	} else {
		$("input[name='name']").removeAttr('style');
	}
	
	var max_capacity = 0;
	
	for (var i = 0; $("input[name='slot"+i+"']").length; ++i) {
		if ($("input[name='slot"+i+"']").val() == "") {
			$("input[name='slot"+i+"']").css({'border-color' : '#FF0000'});
		} else {
			$("input[name='slot"+i+"']").removeAttr('style');
		}
		if ($("input[name='vmin"+i+"']").val() > $("input[name='vmax"+i+"']").val()) {
			$("input[name='vmin"+i+"']").css({'border-color' : '#FF0000'});
			$("input[name='vmax"+i+"']").css({'border-color' : '#FF0000'});
		} else {
			$("input[name='vmin"+i+"']").removeAttr('style');
			$("input[name='vmax"+i+"']").removeAttr('style');
		}
		max_capacity += Number($("input[name='vmax"+i+"']").val());
	}
	
	var mails = $("#mails").val().split(/[\s,]+/);
	
	if (mails.length > max_capacity) {
		$(".vmax").css({'border-color' : '#FF0000'});
	} else {
		$(".vmax").removeAttr('style');
	}
	
	if ($("#mails").val() == "" || mails.length > max_capacity) {
		$("#mails").css({'border-color' : '#FF0000'});
	} else {
		$("#mails").removeAttr('style');
	}
	
	if ($("input[name='deadline']").val() == "") {
		$("input[name='deadline']").css({'border-color' : '#FF0000'});
	} else {
		$("input[name='deadline']").removeAttr('style');
	}
}
</script>


</head>
<body>

<h1>Activities Web</h1>

Activity Name:<br />
<input type="text" name="name" value=""><br />
<br />

Number of slots:<br />
<input type="number" name="nslots" min="1" max="100" step="1" value="2"><br />
<div id="slots"></div><br />
<br />

Mail list:<br />
<textarea id="mails" rows="5" cols="50">mail1, mail2, mail3, ...</textarea><br />
<br />

Deadline: <input type="date" name="deadline"><br />
<br />

<button type="button" id="send">Send</button><br />

<textarea readonly id="output" rows="5" cols="50"></textarea>

</body>
</html>


