<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

<style>
body {
    background-color: linen;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
}
#content {
    display: inline-block;
}
h1 {
    color: maroon;
    margin-left: 20px;
}
p {
	margin-left: 5px;
}
</style>

<script>
var key = window.location.pathname.split("/")[2];
var x = null;
var deadline = null;
var now = new Date();

$(document).ready(function() {
	$.post("/info", '{ "key" : "'+key+'" }', function(data,status) {
		if (status == "success") {
			x = eval('(' + data + ')');
			$("#name").text('Activity name: '+x.name);
			$("#mail").text('Your email: '+x.mail);
			
			deadline = new Date(x.deadline);
			
			if (deadline > now) {
				var hours = Math.floor((deadline-now)/1000/3600);
				var days = Math.floor(hours / 24);
				hours = hours % 24;
				$("#deadline").text('Deadline: '+deadline.toJSON().split('T')[0]+' (in '+days+' days and '+hours+' hours)');
			} else {
				var days = Math.floor((now-deadline)/1000/3600/24);
				$("#deadline").text('Deadline: '+deadline.toJSON().split('T')[0]+' ('+days+' days ago)');
			}
						
			if (x.results.length > 0) {
				var content = '<table border="1"><tr><th>Slot Name</th><th>Mail</th></tr>';
				var n = x.slots.length;
				for (i=0; i< n; ++i) {
					var list = [];
					for (j=0; j < x.mails.length; ++j) {
						if (x.results[j] == i) {
							list.push(x.mails[j]);
						}
					}
					content += '<tr><th>'+x.slots[i]+'</th><th>'+list.join(", ")+'</th></tr>';
				}
				content += '</table>';
				$("#content").html(content);
			} else {
				var content = '<table border="1"><tr><th>Slot Name</th><th>Wish</th></tr>';
				var n = x.slots.length;
				for (i=0; i< n; ++i) {
					content += '<tr><th>'+x.slots[i]+'</th><th><input type="number" name="wish'+i+'" min="1" max="'+n+'" step="1" value="'+(n-x.wish[i])+'"></th></tr>';
				}
				content += '</table>';
				$("#content").html(content);
				$("input").bind('input propertychange', upload_wish);
				$("input").bind('input propertychange', color_wish);
				color_wish();
			}
		}
	});
});

function upload_wish() {
	var wish = [];
	var n = x.slots.length;
	for (var i = 0; i < n; ++i) {
		wish.push(n - Number($("input[name='wish"+i+"']").val()));
	}
	
	var data = '{ "key" : "'+key+'", "wish" : ['+wish.join(",")+'] }';
	console.log(data);
	
	$.ajax({
		type: "POST",
		url: "/fill",
		data: data,
		success: function(data) {
			console.log(data);
			$("input").css({'border-color' : ''});
			$("#error").text('');
		},
		error: function(data) {
			console.log(data);
			$("input").css({'border-color' : '#FF0000'});
			$("#error").text('The values are not valid: each number must appear one time');
		},
	});
}

function color_wish() {
	var colormap = ['#40ff00', '#80ff00', '#bfff00', '#ffff00', '#ffbf00', '#ff8000', '#ff4000', '#ff0000'];
	var n = x.slots.length;
	for (var i = 0; i < n; ++i) {
		var v = n - Number($("input[name='wish"+i+"']").val());
		// v = 0 .. n-1
		v = v * (colormap.length - 1) / (n - 1);
		v = Math.round(v);
		$("input[name='wish"+i+"']").css({'background-color' : colormap[v]});
	}
}

</script>
</head>
<body>

<h1>Activities Web</h1>

<p id="name">Waiting for request...</p>
<p id="mail"></p>
<p id="deadline"></p>

<div id="content"></div>
<p id="error"></p>

</body>
</html>


